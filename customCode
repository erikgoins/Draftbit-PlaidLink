import React from 'react';
import PlaidLink from '@burstware/expo-plaid-link';

import * as GlobalVariableContext from './config/GlobalVariableContext';
export { useValues, useSetValue } from './config/GlobalVariableContext';

export const ExpoPlaidLink = ({ LinkToken, navigation }) => {
  //Notice that the props are destructured { LinkToken,navigation }
  const variables = GlobalVariableContext.useValues();
  const setVariable = GlobalVariableContext.useSetValue();
  return (
    <PlaidLink
      linkToken = {variables.LinkToken}
      onEvent={event => console.log(event)}
      onExit={exit => console.log(exit)}
      onSuccess={success => {
        setVariable({ key: 'PublicToken', value: success.publicToken }); //sets the PublicToken variable in the DraftBit app
       
        //Call Plaid Public Token Exchange: PublicToken -> AccessToken
        return fetch('https://sandbox.plaid.com/item/public_token/exchange', {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
           },
           body: JSON ({
            "client_id": "xxxxxx",
            "secret": "xxxxxx",
            "public_token": success.publicToken
           })
           .then setVariable({ key: 'AccessToken', value: access_token });
          })
          .catch((error) => {
            console.error(error);  
         });
         
        navigation.navigate('PlaidLinkSuccessScreen'); //navigation away from the PlaidLink screen
      }}
    />
  );
};
